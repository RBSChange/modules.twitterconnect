<?xml version="1.0"?>
<bindings xmlns="http://www.mozilla.org/xbl" xmlns:xbl="http://www.mozilla.org/xbl" xmlns:html="http://www.w3.org/1999/xhtml" xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">

	<!-- Base twitter panel -->
	
	<binding id="cBaseTweetsPanel" extends="layout.cDocumentEditor#cDocumentEditorPanelFields">
		<resources>
			<stylesheet src="modules.uixul.cFieldsGroup" />
			<stylesheet src="modules.twitterconnect.cTwitterPanel" />
		</resources>
		
		<implementation>
			<field name="mWebsiteId">null</field>
			<field name="mModel">null</field>
			<field name="mId">null</field>
			<field name="mFieldNames">['accounts', 'tweetContents', 'website']</field>
			
			<property name="moduleName" readonly="true">
				<getter><![CDATA[
					return this.documentEditor.mModule.name;
				]]></getter>
			</property>
			
			<constructor><![CDATA[
				this.mId = Math.round(Math.random()*100000);
				for (var i = 0; i < this.mFieldNames.length; i++)
				{
					this.updateCFieldId('field_'+this.mFieldNames[i]);
					this.updateCLabelId('field_'+this.mFieldNames[i]);
				}
			]]></constructor>
		
			<method name="updateCFieldId">
				<parameter name="anonId" />
				<body><![CDATA[
					var node = this.getElementByAnonId(anonId);
					node.setAttribute('id', 'twitterconnect_cTweetsPanel_'+anonId+'_'+this.mId);
				]]></body>
			</method>
		
			<method name="updateCLabelId">
				<parameter name="anonId" />
				<body><![CDATA[
					var labelAnonId = anonId + '_label';
					var node = this.getElementByAnonId(labelAnonId);
					node.setAttribute('id', 'twitterconnect_cTweetsPanel_'+labelAnonId+'_'+this.mId);
					node.setAttribute('control', 'twitterconnect_cTweetsPanel_'+anonId+'_'+this.mId);
				]]></body>
			</method>
			
			<method name="changeWebsite">
				<parameter name="websiteId" />
				<body><![CDATA[
					try
					{
						this.mWebsiteId = websiteId;
						this.fields.accounts.replaceItems({cmpref: 'modules_twitterconnect/authorizedaccountsbywebsite', websiteId: this.mWebsiteId});
						this.mustReloadOptions();
					}
					catch (e)
					{
						wCore.error("onWebsiteChanged", [node], e);
					}
				]]></body>
			</method>
			
			<method name="getInitializeParameters">
				<body><![CDATA[
					return {
						module: 'twitterconnect',
						action: 'LoadTweetsByTarget', 
						relatedId: this.documentEditor.documentid, 
						lang: Context.W_LANG,
						startIndex: this.mStartIndex,
						pageSize: this.mPageSize,
						currentModule: this.moduleName
					};
				]]></body>
			</method>
									
			<method name="fireInitializeComplete">
				<parameter name="result" />
				<body><![CDATA[
					if (result.status != "OK")
					{
						this.showErrorMessage(result.contents.errorMessage);
						this.collapseContentZone(true);
						this.mInitialized = true;
						return;
					}
										
					if (!this.mInitialized)
					{
						this.mustReloadOptions();
						
						this.collapseContentZone(false);
						this.mInitialized = true;
						this.mModel = null;
						
						var websitesInfos = result.contents.websitesInfos;
						if ('websitesData' in websitesInfos)
						{
							this.getElementByAnonId('website-row').removeAttribute('hidden');
							
							var websiteList = this.getElementByAnonId('field_website');
							websiteList.removeItems();
							var websitesData = websitesInfos.websitesData;
							var websiteData;
							for (var i = 0; i < websitesData.length; i++)
							{
								websiteData = websitesData[i];
								websiteList.appendItem(websiteData.label, websiteData.id);
							}
							
							this.changeWebsite(websitesData[0].id);
							var valid = this.setInitialValues(this.fields, {website: this.mWebsiteId.toString()});
						}
						else if ('websiteId' in websitesInfos)
						{
							this.getElementByAnonId('website-row').setAttribute('hidden', 'true');
							this.changeWebsite(websitesInfos.websiteId);
							var valid = this.setInitialValues(this.fields, {website: this.mWebsiteId.toString()});
						}
					}
					this.updateCommonDataInPanel(result);
					this.gotoTop();
				]]></body>
			</method>
			
			<method name="mustReloadOptions">
				<body><![CDATA[
					var node = this.getElementByAnonId('field_tweetContents');
					node.setAttribute('mustReloadOptions', true);
					node.setAttribute('moduleName', this.moduleName);
					node.setAttribute('relatedId', this.documentEditor.documentid);
					if (this.mWebsiteId)
					{
						node.setAttribute('websiteId', this.mWebsiteId);
					}
					else
					{
						node.removeAttribute('websiteId');
					}
					if (this.mModel)
					{
						node.setAttribute('modelName', this.mModel);
					}
					else
					{
						node.removeAttribute('modelName');
					}
				]]></body>
			</method>
			
			<method name="setupReplacements">
				<parameter name="replacements" />
				<body><![CDATA[
					var node = this.getElementByAnonId('field_tweetContents');
					node.clearSubstitutions();
					for (var i = 0; i < replacements.length; i++)
					{
						replacement = replacements[i];
						node.addSubstitution(replacement.label, replacement.name, replacement.value, replacement.maxLength, replacement.tooltip);
					}
				]]></body>
			</method>
			
			<method name="updateCommonDataInPanel">
				<parameter name="result" />
				<body><![CDATA[
					this.getElementByAnonId('panel-content').removeAttribute('hidden', 'true');							
					this.initializeForm(result);					
					this.refreshTweetList(result);
					this.refreshPlannerList(result);
				]]></body>
			</method>
			
			<method name="initializeForm">
				<parameter name="result" />
				<body><![CDATA[
					// Nothing done by default.
				]]></body>
			</method>
			
			<method name="refreshTweetList">
				<parameter name="result" />
				<body><![CDATA[
					var tweets = result.contents.tweetsInfos.tweets;
					var tweet;
					var section;
					var tweetsNode = this.getElementByAnonId('tweets');
					for (var i = 0; i < tweets.length; i++)
					{
						tweet = tweets[i];
						section = tweetsNode.childNodes[i];
						if (section == null)
						{
							section = document.createElementNS('http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul', 'section');
							section.className = 'tweet';
							section.panel = this;
							tweetsNode.appendChild(section);
						}
						else
						{
							section.removeAttribute('collapsed');
							section.removeChild(section.firstChild);
						}
						section.appendChild(document.createTextNode(tweet['contents']));
						
						if (tweet.relatedId != this.documentEditor.documentid)
						{
							section.removeAttribute('hideRelatedInfos');
						}
						else
						{
							section.setAttribute('hideRelatedInfos', true);
						}
						
						for (var name in tweet)
						{
							section.setAttribute(name, tweet[name]);
							if (tweet[name] && tweet[name] != '')
							{
								section.removeAttribute(name+'hidden');
							}
							else
							{
								section.setAttribute(name+'hidden', true);
							}
						}
					}
					while (section = tweetsNode.childNodes[i])
					{
						section.setAttribute('collapsed', 'true');
						i++;
					}
					
					var tweetInfos = result.contents.tweetsInfos;
					this.mStartIndex = tweetInfos.startIndex;
					this.mDocumentTotal = tweetInfos.total;
					this.mRowCount = tweetInfos.tweets.length;
					this.getElementByAnonId('paginator').updateNavigation(this);
				]]></body>
			</method>
			
			<method name="refreshPlannerList">
				<parameter name="result" />
				<body><![CDATA[
					var plannersNode = this.getElementByAnonId('tweets-planners');
					if (!plannersNode)
					{
						return;
					}
					var planners = result.contents.plannersInfos.planners;
					var planner;
					var section;
					for (var i = 0; i < planners.length; i++)
					{
						planner = planners[i];
						section = plannersNode.childNodes[i];
						if (section == null)
						{
							section = document.createElementNS('http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul', 'section');
							section.className = 'planner';
							section.panel = this;
							plannersNode.appendChild(section);
						}
						else
						{
							section.removeAttribute('collapsed');
							section.removeChild(section.firstChild);
						}
						section.appendChild(document.createTextNode(planner['contents']));
						
						for (var name in planner)
						{
							section.setAttribute(name, planner[name]);
							if (planner[name] && planner[name] != '')
							{
								section.removeAttribute(name+'hidden');
							}
							else
							{
								section.setAttribute(name+'hidden', true);
							}
						}
					}
					while (section = plannersNode.childNodes[i])
					{
						section.setAttribute('collapsed', 'true');
						i++;
					}
				]]></body>
			</method>
			
			<field name="mPageSize">5</field>
			<field name="mStartIndex">0</field>
			<field name="mDocumentTotal">0</field>
			<field name="mRowCount">0</field>
			
			<method name="navigate">
				<parameter name="startIndex" />
				<body><![CDATA[
					this.mStartIndex = startIndex;
					var me = this;
					wCore.executeJSON('twitterconnect', 'LoadTweetsByTarget', this.getInitializeParameters(), function (result) { me.fireInitializeComplete(result); }, true);
				]]></body>
			</method>
		</implementation>
	</binding>

	<!-- Twitter panel for document -->

	<binding id="cTweetsPanel" extends="modules.twitterconnect.cTwitterEditor#cBaseTweetsPanel">
		<resources>
			<stylesheet src="modules.uixul.cFieldsGroup" />
			<stylesheet src="modules.twitterconnect.cTwitterPanel" />
		</resources>
		<content>
			<xul:vbox flex="1">
				<xul:cmessageinfo anonid="message" />
				<xul:scrollbox anonid="scrollctrl" flex="1" class="editordatacontainer" orient="vertical">
					<xul:box class="box-inherit scrollbox-innerbox" flex="1" orient="vertical" anonid="panel-content">
						<xul:groupbox>
							<xul:caption flex="1">
								<xul:vbox pack="center"><xul:image src="{IconsBase}/small/add.png" /></xul:vbox>
								<xul:label value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.title,ucf,attr}" />
							</xul:caption>
							<xul:grid>
								<xul:columns>
									<xul:column />
									<xul:column flex="1"/>
								</xul:columns>
								<xul:rows>
									<xul:row anonid="website-row">
										<xul:clabel anonid="field_website_label" value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.website,ucf,attr}" />
										<xul:cfield name="accounts" anonid="field_website" fieldtype="dropdownlist" hidehelp="true" />
									</xul:row>
									<xul:row>
										<xul:clabel anonid="field_accounts_label" value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.accounts,ucf,attr}" />
										<xul:cfield name="accounts" anonid="field_accounts" fieldtype="checklist" hidehelp="true" required="true" />
									</xul:row>
									<xul:row>
										<xul:clabel anonid="field_tweetContents_label" value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.contents,ucf,attr}" />
										<xul:cfield name="tweetContents" anonid="field_tweetContents" fieldtype="tweetcontents" class="with-counter" cols="70" rows="3" hidehelp="true" required="true">
											<xul:cconstraint name="maxSize" parameter="140" />
										</xul:cfield>
									</xul:row>
									<xul:row>
										<xul:spacer />
										<xul:hbox>
											<xul:button anonid="sendTweetNowButton" disabled="true" label="${trans:m.twitterconnect.bo.doceditor.panel.tweets.send-now,ucf,attr}" image="{IconsBase}/small/tweet.png" />
											<xul:button anonid="sendTweetOnPublishButton" disabled="true" label="${trans:m.twitterconnect.bo.doceditor.panel.tweets.send-on-publish,ucf,attr}" image="{IconsBase}/small/tweet.png" />
											<xul:spacer flex="1" />
											<xul:cfield name="plannedDate" anonid="field_plannedDate" fieldtype="datetime" hidehelp="true" initialvalue="" />
											<xul:button anonid="planTweetButton" disabled="true" label="${trans:m.twitterconnect.bo.doceditor.panel.tweets.plan,ucf,attr}" image="{IconsBase}/small/planned-tweet.png" />
										</xul:hbox>
									</xul:row>
								</xul:rows>
							</xul:grid>
						</xul:groupbox>
						<xul:groupbox>
							<xul:caption flex="1">
								<xul:vbox pack="center"><xul:image src="{IconsBase}/small/tweet.png" /></xul:vbox>
								<xul:hbox align="center">
									<xul:label value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.tweet-list,ucf,attr}" />
								</xul:hbox>
								<xul:spacer flex="1" />
								<xul:cpaginator anonid="paginator" hideseparator="true" />
								<xul:spacer flex="1" />
								<xul:toolbarbutton oncommand="refresh()" image="{IconsBase}/small/refresh.png" label="${trans:m.uixul.bo.general.refresh,ucf,attr}" />
							</xul:caption>
							<xul:vbox anonid="tweets" />
						</xul:groupbox>
						<xul:spacer flex="1" />
					</xul:box>
				</xul:scrollbox>
			</xul:vbox>
		</content>
		<implementation>
			<constructor><![CDATA[
				var me = this;
				this.updateCFieldId('field_plannedDate');
				this.getElementByAnonId('sendTweetNowButton').addEventListener('command', function () { me.sendNewTweet(this); }, true);
				this.getElementByAnonId('sendTweetOnPublishButton').addEventListener('command', function () { me.sendNewTweetOnPublish(this); }, true);
				this.getElementByAnonId('planTweetButton').addEventListener('command', function () { me.planNewTweet(this); }, true);
				this.getElementByAnonId('field_website').addEventListener('fieldChanged', function () { me.changeWebsite(this.value); }, true);
			]]></constructor>
		
			<method name="updateCommandsUI">
				<body><![CDATA[
					this.getElementByAnonId('sendTweetNowButton').disabled = this.error;
					this.getElementByAnonId('sendTweetOnPublishButton').disabled = this.error;
					this.getElementByAnonId('planTweetButton').disabled = this.error;
				]]></body>
			</method>
									
			<method name="initializeForm">
				<parameter name="result" />
				<body><![CDATA[
					var relatedInfos = result.contents.relatedInfos;
					if (relatedInfos.isPublished)
					{
						this.getElementByAnonId('sendTweetNowButton').removeAttribute('hidden');
						this.getElementByAnonId('sendTweetOnPublishButton').setAttribute('hidden', 'true');
					}
					else
					{
						this.getElementByAnonId('sendTweetNowButton').setAttribute('hidden', 'true');
						this.getElementByAnonId('sendTweetOnPublishButton').removeAttribute('hidden');
					}
					
					this.mustReloadOptions();
				]]></body>
			</method>
			
			<method name="sendNewTweet">
				<parameter name="button" />
				<body><![CDATA[
					var accounts = this.getElementByAnonId('field_accounts').value;
					var node = this.getElementByAnonId('field_tweetContents');
					var websiteId = this.mWebsiteId;
					var relatedId = this.documentEditor.documentid;
					var result = wCore.executeJSON('twitterconnect', 'SendTweet', {currentModule: this.moduleName, accounts: accounts, contents: node.value, websiteId: websiteId, relatedId: relatedId, pageSize: this.mPageSize}, null, true);
					if (result.status != 'OK')
					{	
						this.showErrorMessage(result.contents.errorMessage);
					}
					else
					{
						this.mInitialized = false;
						this.fireInitializeComplete(result);
						this.showTextMessage("${trans:m.twitterconnect.bo.doceditor.panel.tweets.success-sending-tweet,ucf,js}");
					}
				]]></body>
			</method>
			
			<method name="sendNewTweetOnPublish">
				<parameter name="button" />
				<body><![CDATA[
					var accounts = this.getElementByAnonId('field_accounts').value;
					var node = this.getElementByAnonId('field_tweetContents');
					var websiteId = this.mWebsiteId;
					var relatedId = this.documentEditor.documentid;
					var result = wCore.executeJSON('twitterconnect', 'SendTweetOnPublish', {currentModule: this.moduleName, accounts: accounts, contents: node.value, websiteId: websiteId, relatedId: relatedId, pageSize: this.mPageSize}, null, true);
					if (result.status != 'OK')
					{	
						this.showErrorMessage(result.contents.errorMessage);
					}
					else
					{
						this.showTextMessage("${trans:m.twitterconnect.bo.doceditor.panel.tweets.success-planning-tweet-on-publish,ucf,js}");
						this.fireInitializeComplete(result);
					}
				]]></body>
			</method>
			
			<method name="planNewTweet">
				<parameter name="button" />
				<body><![CDATA[
					var accounts = this.getElementByAnonId('field_accounts').value;
					var plannedDate = this.getElementByAnonId('field_plannedDate').value;
					if (!plannedDate)
					{
						this.showErrorMessage("${trans:m.twitterconnect.bo.doceditor.panel.tweets.error-no-date-to-plan,ucf,js}");
						return;
					}
					var node = this.getElementByAnonId('field_tweetContents');
					var websiteId = this.mWebsiteId;
					var relatedId = this.documentEditor.documentid;
					var result = wCore.executeJSON('twitterconnect', 'PlanTweet', {currentModule: this.moduleName, accounts: accounts, contents: node.value, websiteId: websiteId, relatedId: relatedId, plannedDate: plannedDate, pageSize: this.mPageSize}, null, true);
					if (result.status != 'OK')
					{	
						this.showErrorMessage(result.contents.errorMessage);
					}
					else
					{
						this.showTextMessage("${trans:m.twitterconnect.bo.doceditor.panel.tweets.success-planning-tweet,ucf,js}");
						this.fireInitializeComplete(result);
					}
				]]></body>
			</method>
			
			<method name="refresh">
				<body><![CDATA[
					this.documentEditor.executeServerAction('tweets', 'Initialize');
				]]></body>
			</method>
		</implementation>
	</binding>
	
	<!-- Tweet panel for conainer -->
	
	<binding id="cContainerTweetsPanel" extends="modules.twitterconnect.cTwitterEditor#cBaseTweetsPanel">
		<resources>
			<stylesheet src="modules.uixul.cFieldsGroup" />
			<stylesheet src="modules.twitterconnect.cTwitterPanel" />
		</resources>
		<content>
			<xul:vbox flex="1">
				<xul:cmessageinfo anonid="message" />
				<xul:scrollbox anonid="scrollctrl" flex="1" orient="vertical" class="editordatacontainer">
					<xul:box class="box-inherit scrollbox-innerbox" flex="1" orient="vertical" anonid="panel-content">
						<xul:groupbox>
							<xul:caption flex="1">
								<xul:vbox pack="center"><xul:image src="{IconsBase}/small/add.png" /></xul:vbox>
								<xul:label value="${trans:m.twitterconnect.bo.doceditor.panel.container-tweets.title,ucf,attr}" />
							</xul:caption>
							<xul:grid>
								<xul:columns>
									<xul:column />
									<xul:column flex="1"/>
								</xul:columns>
								<xul:rows>
									<xul:row>
										<xul:clabel anonid="field_label_label" value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.label,ucf,attr}" />
										<xul:cfield name="label" anonid="field_label" fieldtype="text" hidehelp="true" required="true" />
									</xul:row>
									<xul:row anonid="website-row">
										<xul:clabel anonid="field_website_label" value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.website,ucf,attr}" />
										<xul:cfield name="accounts" anonid="field_website" fieldtype="dropdownlist" hidehelp="true" />
									</xul:row>
									<xul:row>
										<xul:clabel anonid="field_accounts_label" value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.accounts,ucf,attr}" />
										<xul:cfield name="accounts" anonid="field_accounts" fieldtype="checklist" hidehelp="true" required="true" />
									</xul:row>
									<xul:row anonid="model-row">
										<xul:clabel anonid="field_model_label" value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.model,ucf,attr}" />
										<xul:cfield name="model" anonid="field_model" fieldtype="dropdownlist" hidehelp="true" required="true" />
									</xul:row>
									<xul:row>
										<xul:clabel anonid="field_tweetContents_label" value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.contents,ucf,attr}" />
										<xul:cfield name="tweetContents" anonid="field_tweetContents" fieldtype="tweetcontents" class="with-counter" cols="70" rows="3" hidehelp="true" required="true">
											<xul:cconstraint name="maxSize" parameter="140" />
										</xul:cfield>
									</xul:row>
									<xul:row>
										<xul:spacer />
										<xul:hbox>
											<xul:button anonid="planTweetsOnPublishButton" disabled="true" label="${trans:m.twitterconnect.bo.doceditor.panel.tweets.send-on-publish,ucf,attr}" image="{IconsBase}/small/tweet.png" />
											<xul:spacer flex="1" />
											<xul:hbox anonid="planPeriodicTweetsButtonBox">
												<xul:cfield name="period" anonid="field_period" fieldtype="duration" hidehelp="true" hidehours="false"/>
												<xul:button anonid="planPeriodicTweetsButton" disabled="true" label="${trans:m.twitterconnect.bo.doceditor.panel.tweets.periodic,ucf,attr}" image="{IconsBase}/small/planned-tweet.png" />
											</xul:hbox>
										</xul:hbox>
									</xul:row>
								</xul:rows>
							</xul:grid>
						</xul:groupbox>
						<xul:groupbox>
							<xul:caption flex="1">
								<xul:vbox pack="center"><xul:image src="{IconsBase}/small/tweet-planner.png" /></xul:vbox>
								<xul:hbox align="center">
									<xul:label value="${trans:m.twitterconnect.bo.doceditor.panel.container-tweets.planner-list,ucf,attr}" />
								</xul:hbox>
								<xul:spacer flex="1" />
								<xul:toolbarbutton oncommand="refresh()" image="{IconsBase}/small/refresh.png" label="${trans:m.uixul.bo.general.refresh,ucf,attr}" />
							</xul:caption>
							<xul:vbox anonid="tweets-planners" />
						</xul:groupbox>
						<xul:groupbox>
							<xul:caption flex="1">
								<xul:vbox pack="center"><xul:image src="{IconsBase}/small/tweet.png" /></xul:vbox>
								<xul:hbox align="center">
									<xul:label value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.tweet-list,ucf,attr}" />
								</xul:hbox>
								<xul:spacer flex="1" />
								<xul:cpaginator anonid="paginator" hideseparator="true" />
								<xul:spacer flex="1" />
								<xul:toolbarbutton oncommand="refresh()" image="{IconsBase}/small/refresh.png" label="${trans:m.uixul.bo.general.refresh,ucf,attr}" />
							</xul:caption>
							<xul:vbox anonid="tweets" />
						</xul:groupbox>
						<xul:spacer flex="1" />
					</xul:box>
				</xul:scrollbox>
			</xul:vbox>
		</content>
		<implementation>
			<field name="mWebsiteId">null</field>
			<field name="mId">null</field>
			<field name="mFieldNames">['accounts', 'tweetContents', 'website', 'label', 'model']</field>
		
			<constructor><![CDATA[
				var me = this;
				this.getElementByAnonId('planTweetsOnPublishButton').addEventListener('command', function () { me.planTweetsOnPublish(this); }, true);
				this.getElementByAnonId('planPeriodicTweetsButton').addEventListener('command', function () { me.planPeriodicTweets(this); }, true);
				this.getElementByAnonId('field_website').addEventListener('fieldChanged', function () { me.onWebsiteChanged(this); }, true);
			]]></constructor>
		
			<method name="hideModel">
				<body><![CDATA[
					this.getElementByAnonId('model-row').setAttribute('hidden', 'true');
					this.getElementByAnonId('field_model').setAttribute('required', 'false');
				]]></body>
			</method>
			
			<method name="showModel">
				<body><![CDATA[
					this.getElementByAnonId('model-row').removeAttribute('hidden');
					this.getElementByAnonId('field_model').setAttribute('required', 'true');
				]]></body>
			</method>
		
			<method name="initializeForm">
				<parameter name="result" />
				<body><![CDATA[
					var containerInfos = result.contents.containerInfos;
					if ('model' in containerInfos)
					{
						this.hideModel();
													
						this.mModel = containerInfos.model;
						this.getElementByAnonId('field_model').value = this.mModel;
						this.mustReloadOptions();
					}
					else if ('allowedModels' in containerInfos)
					{
						this.showModel();
												
						var modelList = this.getElementByAnonId('field_model');
						modelList.removeItems();
						var modelsData = containerInfos.allowedModels;
						var modelData;
						for (var i = 0; i < modelsData.length; i++)
						{
							modelData = modelsData[i];
							modelList.appendItem(modelData.label, modelData.name);
						}
						
						this.mModel = modelsData[0].id;
						modelsData.value = this.mModel;							
					}
					else
					{
						this.getElementByAnonId('panel-content').setAttribute('hidden', 'true');
						this.showErrorMessage("${trans:m.twitterconnect.bo.doceditor.panel.tweets.error-document-has-no-allowed-model,ucf,js}");
					}
				
					if (containerInfos.allowPeriodic)
					{
						this.getElementByAnonId('planPeriodicTweetsButtonBox').removeAttribute('hidden');
					}
					else
					{
						this.getElementByAnonId('planPeriodicTweetsButtonBox').setAttribute('hidden', 'true');
					}
					if (containerInfos.allowOnPublish)
					{
						this.getElementByAnonId('planTweetsOnPublishButton').removeAttribute('hidden');
					}
					else
					{
						this.getElementByAnonId('planTweetsOnPublishButton').setAttribute('hidden', 'true');
					}
				]]></body>
			</method>
			
			<method name="onModelChanged">
				<parameter name="node" />
				<body><![CDATA[
					this.mModel = node.value;
					this.mustReloadOptions();
				]]></body>
			</method>
			
			<method name="updateCommandsUI">
				<body><![CDATA[
					this.getElementByAnonId('planTweetsOnPublishButton').disabled = this.error;
					this.getElementByAnonId('planPeriodicTweetsButton').disabled = this.error;
				]]></body>
			</method>
			
			<method name="planTweetsOnPublish">
				<parameter name="button" />
				<body><![CDATA[
					var label = this.getElementByAnonId('field_label').value;
					var model = this.getElementByAnonId('field_model').value;
					var accounts = this.getElementByAnonId('field_accounts').value;
					var node = this.getElementByAnonId('field_tweetContents');
					var websiteId = this.mWebsiteId;
					var containerId = this.documentEditor.documentid;
					var result = wCore.executeJSON('twitterconnect', 'PlanTweetsOnPublish', {currentModule: this.moduleName, label: label, accounts: accounts, contents: node.value, websiteId: websiteId, containerId: containerId, model: model, pageSize: this.mPageSize}, null, true);
					if (result.status != 'OK')
					{	
						this.showErrorMessage(result.contents.errorMessage);
					}
					else
					{
						this.showTextMessage("${trans:m.twitterconnect.bo.doceditor.panel.tweets.success-planning-tweets-on-contained-document-publish,ucf,js}");
						this.fireInitializeComplete(result);
					}
				]]></body>
			</method>
			
			<method name="planPeriodicTweets">
				<parameter name="button" />
				<body><![CDATA[
					var label = this.getElementByAnonId('field_label').value;
					var model = this.getElementByAnonId('field_model').value;
					var accounts = this.getElementByAnonId('field_accounts').value;
					var node = this.getElementByAnonId('field_tweetContents');
					var websiteId = this.mWebsiteId;
					var containerId = this.documentEditor.documentid;
					var period = this.getElementByAnonId('field_period').value;
					var result = wCore.executeJSON('twitterconnect', 'PlanPeriodicTweets', {currentModule: this.moduleName, label: label, accounts: accounts, contents: node.value, websiteId: websiteId, containerId: containerId, model: model, period: period, pageSize: this.mPageSize}, null, true);
					if (result.status != 'OK')
					{	
						this.showErrorMessage(result.contents.errorMessage);
					}
					else
					{
						this.showTextMessage("${trans:m.twitterconnect.bo.doceditor.panel.tweets.success-planning-periodic-tweets-on-contained-documents,ucf,js}");
						this.fireInitializeComplete(result);
					}
				]]></body>
			</method>
			
			<method name="refresh">
				<body><![CDATA[
					this.documentEditor.executeServerAction('containertweets', 'Initialize');
				]]></body>
			</method>
		</implementation>
	</binding>
	
	<!-- Internal bindings -->
	
	<binding id="cTweetInfos">
		<resources>
			<stylesheet src="modules.uixul.cFieldsGroup" />
			<stylesheet src="modules.twitterconnect.cTwitterPanel" />
		</resources>
		<content>
			<xul:groupbox flex="1" xbl:inherits="class=sendingStatus">
				<xul:caption flex="1" >
					<xul:vbox pack="center"><xul:image xbl:inherits="src=iconUrl" /></xul:vbox>
					<xul:label xbl:inherits="value=sendingStatusFullLabel" />
					<xul:label value="-" />
					<xul:label value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.on-account,ucf,attr}" />
					<xul:label xbl:inherits="value=accountLabel" />
				</xul:caption>
				<xul:hbox flex="1" >
					<xul:hbox flex="1" class="allow-text-selection">
						<xbl:children />
					</xul:hbox>
					<xul:toolbarbutton xbl:inherits="disabled=disableDelete" anonid="delete" image="{IconsBase}/small/delete.png" label="${trans:m.uixul.bo.actions.delete,ucf,attr}" />
					<xul:toolbarbutton xbl:inherits="disabled=disableResend" anonid="resend" image="{IconsBase}/small/refresh.png" label="${trans:m.twitterconnect.bo.actions.resend,ucf,attr}" />
				</xul:hbox>
				<xul:hbox flex="1" class="error-message" xbl:inherits="hidden=errorMessagehidden">
					<xul:label xbl:inherits="xbl:text=errorMessage" class="allow-text-selection" />
				</xul:hbox>
				<xul:hbox xbl:inherits="hidden=hideRelatedInfos">
					<xul:label value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.related-document,lab,ucf,attr}" />
					<xul:vbox pack="center"><xul:image xbl:inherits="src=relatedIconUrl" /></xul:vbox>
					<xul:label xbl:inherits="value=relatedCompleteLabel" />
				</xul:hbox>	
			</xul:groupbox>
		</content>
		<implementation>
			<field name="panel">null</field>
			
			<constructor><![CDATA[
				var _this = this;
				
				var node = document.getAnonymousElementByAttribute(this, 'anonid', 'delete');
				node.addEventListener('command', function () { _this.delete(); }, true);
				
				var node = document.getAnonymousElementByAttribute(this, 'anonid', 'resend');
				node.addEventListener('command', function () { _this.resend(); }, true);
			]]></constructor>

			<method name="delete">
				<body><![CDATA[
					if (confirm("${trans:m.twitterconnect.bo.doceditor.actions.confirm-delete-tweet,ucf,js}"))
					{
						this.executeAction('DeleteDocument', "${trans:m.twitterconnect.bo.doceditor.actions.success-deleting-tweet,ucf,js}");
					}
				]]></body>
			</method>

			<method name="resend">
				<body><![CDATA[
					this.executeAction('ResendTweet', "${trans:m.twitterconnect.bo.doceditor.actions.success-resending-tweet,ucf,js}");
				]]></body>
			</method>

			<method name="executeAction">
				<parameter name="action" />
				<parameter name="successMessage" />
				<body><![CDATA[
					var relatedId = this.panel.documentEditor.documentid;
					var websiteId = this.panel.mWebsiteId;
					var result = wCore.executeJSON('twitterconnect', action, {currentModule: this.panel.moduleName, cmpref: this.getAttribute('documentId'), lang: Context.W_LANG, relatedId: relatedId, websiteId: websiteId, startIndex: this.panel.mStartIndex, pageSize: this.panel.mPageSize}, null, true);
					if (result.status != 'OK')
					{	
						this.panel.showErrorMessage(result.contents.errorMessage);
					}
					else
					{
						this.panel.showTextMessage(successMessage);
						this.panel.fireInitializeComplete(result);
					}
				]]></body>
			</method>
		</implementation>
	</binding>
	
	<binding id="cPlannerInfos">
		<resources>
			<stylesheet src="modules.uixul.cFieldsGroup" />
			<stylesheet src="modules.twitterconnect.cTwitterPanel" />
		</resources>
		<content>
			<xul:groupbox flex="1">
				<xul:caption flex="1" >
					<xul:vbox pack="center"><xul:image src="{IconsBase}/small/tweet-planner.png" /></xul:vbox>
					<xul:label xbl:inherits="value=label" />
					<xul:label value="-" />
					<xul:label xbl:inherits="value=plannerTypeLabel" />
					<xul:label value="-" />
					<xul:label value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.on-accounts,ucf,attr}" />
					<xul:label xbl:inherits="value=accountLabels" />
				</xul:caption>
				<xul:hbox flex="1" >
					<xul:hbox flex="1" class="allow-text-selection">
						<xbl:children />
					</xul:hbox>
					<xul:toolbarbutton anonid="delete" image="{IconsBase}/small/delete.png" label="${trans:m.uixul.bo.actions.delete,ucf,attr}" />
				</xul:hbox>
				<xul:hbox xbl:inherits="hidden=lastTweetDatehidden">
					<xul:label value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.last-tweet-date,lab,ucf,attr}" /> <xul:label xbl:inherits="value=lastTweetDate" />
				</xul:hbox>
				<xul:hbox xbl:inherits="hidden=nextTweetDatehidden">
					<xul:label value="${trans:m.twitterconnect.bo.doceditor.panel.tweets.next-tweet-date,lab,ucf,attr}" /> <xul:label xbl:inherits="value=nextTweetDate" />
				</xul:hbox>
				<xul:hbox flex="1" class="error-message" xbl:inherits="hidden=errorMessagehidden">
					<xul:label xbl:inherits="value=errorMessage" />
				</xul:hbox>
			</xul:groupbox>
		</content>
		<implementation>
			<field name="panel">null</field>
			
			<constructor><![CDATA[
				var _this = this;
				
				var node = document.getAnonymousElementByAttribute(this, 'anonid', 'delete');
				node.addEventListener('command', function () { _this.delete(); }, true);
			]]></constructor>

			<method name="delete">
				<body><![CDATA[
					if (confirm("${trans:m.twitterconnect.bo.doceditor.actions.confirm-delete-tweet,ucf,js}"))
					{
						this.executeAction('DeleteDocument', "${trans:m.twitterconnect.bo.doceditor.actions.success-deleting-planner,ucf,js}");
					}
				]]></body>
			</method>

			<method name="executeAction">
				<parameter name="action" />
				<parameter name="successMessage" />
				<body><![CDATA[
					var relatedId = this.panel.documentEditor.documentid;
					var websiteId = this.panel.mWebsiteId;
					var result = wCore.executeJSON('twitterconnect', action, {currentModule: this.panel.moduleName, cmpref: this.getAttribute('documentId'), lang: Context.W_LANG, relatedId: relatedId, websiteId: websiteId, startIndex: this.panel.mStartIndex, pageSize: this.panel.mPageSize}, null, true);
					if (result.status != 'OK')
					{	
						this.panel.showErrorMessage(result.contents.errorMessage);
					}
					else
					{
						this.panel.showTextMessage(successMessage);
						this.panel.fireInitializeComplete(result);
					}
				]]></body>
			</method>
		</implementation>
	</binding>
	
	<binding id="cReplacedContentsField" extends="form.cField#cLongTextWithCounterField">
		<content>
			<children />
			<xul:hbox xbl:inherits="context,spellcheck" flex="1">
				<xul:textbox anonid="internalcontrol" multiline="true" cols="50" rows="5"
					xbl:inherits="maxlength,disabled,tabindex,accesskey,cols,rows" />
				<xul:vbox>
					<xul:hbox align="center">
						<xul:label anonid="counter" value="0" />
						<xul:label anonid="counter-label" value="${trans:m.uixul.bo.doceditor.character,ucf,attr}" />
					</xul:hbox>
					<xul:hbox align="center" anonid="maximum-box" hidden="true">
						<xul:label value="${trans:m.uixul.bo.doceditor.max-count,ucf,attr}" />
						<xul:label anonid="max-counter-label" />
						<xul:label value="${trans:m.uixul.bo.doceditor.remains,ucf,attr}" />
						<xul:label anonid="remain-counter" value="0" />
					</xul:hbox>
					<xul:toolbar flex="1">
						<xul:toolbarbutton tooltiptext="${trans:m.uixul.bo.doceditor.insert-var,ucf,attr}" image="{IconsBase}/small/add.png"
							anonid="varsmenubutton" type="menu" xbl:inherits="hidden=nocvar">
							<xul:menupopup anonid="varsmenu" onpopupshowing="loadReplacements();">
								<children includes="menuitem" />
							</xul:menupopup>
						</xul:toolbarbutton>
						<xul:toolbarbutton anonid="helpbutton" image="chrome://global/skin/icons/question-16.png"
							tooltiptext="${trans:m.uixul.bo.doceditor.show-help,ucf,attr}"
							xbl:inherits="hidden=hidehelp" oncommand="dispatchFieldEvent('fieldHelp');" />
					</xul:toolbar>
				</xul:vbox>
			</xul:hbox>
		</content>
		<implementation>
			<constructor><![CDATA[
				this.mTimerDelay = 250;
				this.setAttribute('mustReloadOptions', 'true');
			]]></constructor>
				
			<method name="clearSubstitutions">
				<body><![CDATA[
					var menuitems = this.getElementsByTagName('menuitem');
					while (menuitems.length > 0) this.removeChild(menuitems.item(0));
				]]></body>
			</method>
			
			<method name="addSubstitution">
				<parameter name="label" />
				<parameter name="name" />
				<parameter name="value" />
				<parameter name="maxLength" />
				<parameter name="tooltiptext" />
				<body><![CDATA[
					var menuitem = document.createElement('menuitem');
					menuitem.setAttribute('label', label);
					menuitem.setAttribute('cvar', value);
					menuitem.setAttribute('tooltiptext', tooltiptext || label);
					this.appendChild(menuitem);
				]]></body>
			</method>
			
			<method name="loadReplacements">
				<body><![CDATA[
					if (!this.hasAttribute('mustReloadOptions'))
					{
						return;
					}
					
					try
					{
						this.removeAttribute('mustReloadOptions');
						this.clearSubstitutions();
						var menuitem = document.createElement('menuitem');
						menuitem.setAttribute('label', "${trans:m.twitterconnect.bo.doceditor.panel.tweets.items-loading,ucf,js}");
						menuitem.setAttribute('image', '{IconsBase}/small/item-loading.png');
						menuitem.setAttribute('class', 'menuitem-iconic');
						this.appendChild(menuitem);
					
						var params = {currentModule: this.getAttribute('moduleName'), websiteId: this.getAttribute('websiteId'), lang: Context.W_LANG};
						if (this.hasAttribute('modelName'))
						{
							params.model = this.getAttribute('modelName');
						}
						else if (this.hasAttribute('relatedId'))
						{
							params.relatedId = this.getAttribute('relatedId');
						}
						
						var me = this;
						var callback = function(result) {
							if (result.status == 'OK')
							{
								me.setupReplacements(result.contents);
							}
							else
							{
								me.clearSubstitutions();
								var menuitem = document.createElement('menuitem');
								menuitem.setAttribute('label', result.contents.errorMessage);
								menuitem.setAttribute('image', '{IconsBase}/small/error.png');
								menuitem.setAttribute('class', 'menuitem-iconic');
								me.appendChild(menuitem);
							}
						}
						
						var result = wCore.executeJSON('twitterconnect', 'LoadReplacements', params, callback, true);
					}
					catch (e)
					{
						wCore.error("onWebsiteChanged", [node], e);
					}
				]]></body>
			</method>
			
			<method name="setupReplacements">
				<parameter name="replacements" />
				<body><![CDATA[
					this.clearSubstitutions();
					if (replacements.length > 0)
					{
						for (var i = 0; i < replacements.length; i++)
						{
							replacement = replacements[i];
							this.addSubstitution(replacement.label, replacement.name, replacement.value, replacement.maxLength, replacement.tooltip);
						}
					}
					else
					{
						var menuitem = document.createElement('menuitem');
						menuitem.setAttribute('label', "${trans:m.twitterconnect.bo.doceditor.panel.tweets.no-substitution,ucf,js}");
						menuitem.setAttribute('image', '{IconsBase}/small/reject.png');
						menuitem.setAttribute('class', 'menuitem-iconic');
						this.appendChild(menuitem);
					}
				]]></body>
			</method>			
		</implementation>
		
		<handlers>
			<handler event="command"><![CDATA[
				if (event.originalTarget.hasAttribute('cvar'))
				{
					var textbox = this.internalControl;
					var startIndex = textbox.selectionStart;
					var cvar = event.originalTarget.getAttribute('cvar');
					this.value = textbox.value.substring(0, startIndex) + cvar + textbox.value.substring(textbox.selectionEnd);
					var newIndex = startIndex + value.length;
					textbox.setSelectionRange(newIndex, newIndex);
				}
			]]></handler>
		</handlers>
	</binding>
	
	<binding id="cTemplateContentsField" extends="modules.twitterconnect.cTwitterEditor#cReplacedContentsField">
		<implementation>
			<method name="addSubstitution">
				<parameter name="label" />
				<parameter name="name" />
				<parameter name="value" />
				<parameter name="maxLength" />
				<parameter name="tooltiptext" />
				<body><![CDATA[
					this.removeAttribute('nocvar');
					var menuitem = document.createElement('menuitem');
					menuitem.setAttribute('label', label);
					menuitem.setAttribute('cvar', '{'+name+':'+maxLength+'}');
					menuitem.setAttribute('tooltiptext', tooltiptext || label);
					this.appendChild(menuitem);
				]]></body>
			</method>
			
			<method name="getValueLength">
				<body><![CDATA[
					var value = this.internalControl.value;
					value = value.replace(/\{[a-z0-9]+\:([0-9]+)\}/gi, function (str, p1) {
						var result = '';
						var limit = parseInt(p1, 10);
						for (var i = 0; i < limit; i++)
						{
							result += "#"; 
						}
						return result;
					});
					return value.length;
				]]></body>
			</method>		
		</implementation>
	</binding>
</bindings>